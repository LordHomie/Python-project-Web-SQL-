import urllib, os
import urllib.request
from bs4 import BeautifulSoup

from flask import Flask, request, render_template,jsonify
app = Flask(__name__, template_folder='templates')

def do_something(day, city):
    if os.path.isfile('weather.txt'):
        os.remove('weather.txt')

    response = urllib.request.urlopen('https://mgm.gov.tr/eng/forecast-some-world-cities.aspx')
    html = response.read()
    html = html.decode('utf-8')

    with open('weather.txt', 'w', encoding='utf-8') as f:
        f.write(html)

    with open('weather.txt', 'r', encoding='utf-8') as f:
        html = f.read()

    soup = BeautifulSoup(html, 'lxml')

    # parsing today's forecast
    todayTemp = []
    for row in soup.select('tbody > tr'):
        temp = row.select('td')
        city = row.select('th')
        todayTemp.append(
            city[0].text + ": Max " + temp[1].text + " °C, " + "Min " + temp[2].text + " °C"
        )

    dateOFtoday = []
    for row in soup.select('thead > tr'):
        date = row.select('th')
        dateOFtoday.append(
            date[1].text
        )

    if day == '1':
        for elem in todayTemp:
            if city.lower() in elem or city.upper() in elem:
                combine = dateOFtoday[0] + elem
                return combine


@app.route('/')
def home():
    return render_template('flaskApp.html')


# @app.route('/flaskApp', methods=['GET', 'POST'])
@app.route('/join', methods=['GET', 'POST'])
def my_form_post():
    # if request.method == "POST":
        day = request.form['day']
        city = request.form['city']
        combine = do_something(day, city)
        result = {
            "output": combine
        }
        result = {str(key): value for key, value in result.items()}
        return jsonify(result=result)
        # print(result)


if __name__ == '__main__':
    app.run(debug=True)
